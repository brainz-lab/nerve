<!DOCTYPE html>
<html lang="en" class="h-full" data-controller="dark-mode">
  <head>
    <title><%= content_for(:title) || "Dashboard" %> | Nerve</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Nerve">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FAF9F7">
    <meta name="description" content="Nerve - Background job monitoring for Sidekiq, Solid Queue, Resque, DelayedJob, and GoodJob">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Prevent flash of wrong theme on page load and provide toggle function %>
    <script>
      (function() {
        const savedTheme = localStorage.getItem('brainzlab-theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.add('light');
        }

        // Vanilla JS dark mode toggle - works without Stimulus
        window.toggleDarkMode = function() {
          const html = document.documentElement;
          const isDark = html.classList.contains('dark');
          if (isDark) {
            html.classList.remove('dark');
            html.classList.add('light');
            localStorage.setItem('brainzlab-theme', 'light');
          } else {
            html.classList.remove('light');
            html.classList.add('dark');
            localStorage.setItem('brainzlab-theme', 'dark');
          }
          // Update icon if exists
          const icon = document.querySelector('[data-dark-mode-target="icon"]');
          if (icon) {
            icon.innerHTML = isDark
              ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>'
              : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>';
          }
        };
      })();
    </script>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "dark_mode", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <style>
      body {
        font-family: 'Inter', system-ui, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
      ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }
    </style>

    <%# Google Analytics - only in production %>
    <% if Rails.env.production? %>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-CXHFR6PC8W"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-CXHFR6PC8W');
      </script>
    <% end %>
  </head>

  <body class="h-full dm-body-gradient">
    <div class="flex h-full">
      <!-- Sidebar -->
      <aside class="w-64 flex flex-col dm-sidebar-enhanced relative overflow-hidden flex-shrink-0">
        <!-- Decorative gradient blobs -->
        <div class="dm-gradient-mesh">
          <div class="dm-gradient-blob dm-gradient-blob-primary" style="width: 200px; height: 200px; top: -60px; right: -60px;"></div>
          <div class="dm-gradient-blob dm-gradient-blob-secondary" style="width: 150px; height: 150px; bottom: 20%; left: -40px;"></div>
        </div>

        <!-- Logo -->
        <div class="p-5 border-b dm-border-secondary relative z-10">
          <div class="flex flex-col items-end gap-1">
            <div class="flex items-center">
              <%= brainzlab_logo_tag %>
            </div>
            <span class="text-[10px] font-semibold tracking-wider uppercase px-1.5 py-0.5 rounded" style="color: var(--dm-brand); background: color-mix(in srgb, var(--dm-brand) 12%, transparent);">Nerve</span>
          </div>
        </div>

        <!-- Navigation placeholder (Nerve has no sidebar nav in original) -->
        <nav class="p-4 flex-1 relative z-10">
        </nav>

        <!-- Dark mode toggle in sidebar footer -->
        <div class="p-3 border-t dm-border-secondary relative z-10">
          <div class="flex items-center justify-center">
            <button
              type="button"
              class="dark-mode-toggle"
              data-dark-mode-target="icon"
              onclick="toggleDarkMode()"
              aria-label="Toggle dark mode"
              aria-pressed="false"
              title="Toggle dark mode"
            >
              <%# Sun icon - shown in dark mode %>
              <svg class="hidden dark:block w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
              </svg>
              <%# Moon icon - shown in light mode %>
              <svg class="block dark:hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
              </svg>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 overflow-auto relative">
        <!-- Decorative gradient blobs -->
        <div class="dm-gradient-mesh">
          <div class="dm-gradient-blob dm-gradient-blob-primary" style="width: 500px; height: 500px; top: -150px; right: 5%;"></div>
          <div class="dm-gradient-blob dm-gradient-blob-secondary" style="width: 400px; height: 400px; bottom: 10%; left: -100px;"></div>
          <div class="dm-gradient-blob dm-gradient-blob-cyan" style="width: 300px; height: 300px; top: 40%; right: -80px;"></div>
        </div>

        <% if notice %>
          <div class="m-8 mb-0 px-4 py-3 rounded-xl text-[13px] font-medium flex items-center gap-3 dm-success border dm-fade-in-up relative z-10">
            <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <%= notice %>
          </div>
        <% end %>
        <% if alert %>
          <div class="m-8 mb-0 px-4 py-3 rounded-xl text-[13px] font-medium flex items-center gap-3 dm-error border dm-fade-in-up relative z-10">
            <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <%= alert %>
          </div>
        <% end %>

        <div class="p-8 relative z-10">
          <%= yield %>
        </div>
      </main>
    </div>
  </body>
</html>
